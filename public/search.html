<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Search Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
</head>
<body>
<div class="searchPage">
    <div class="searchHeader">
        <h3><a href="/" style="text-decoration: none; color: inherit;">Quick Query</a></h3>
        <div class="searchBar">
            <form id="searchForm" class="input-group input-group-lg" action="/search.html" method="get">
                <input type="text" id="queryInput" class="form-control" placeholder="Type to search..."
                       aria-label="Search Bar" aria-describedby="button-addon2" name="q" required>
                <button class="btn btn-outline-secondary" type="submit" id="button-addon2">Search</button>
            </form>
        </div>
    </div>
    
    <div class="searchHistAndRes">
        <div class="searchHistorySection">
            <h4>Search History</h4>
            <ul id="searchHistoryList" class="list-group"></ul>
        </div>
    
        <div class="searchResultSection">
            <!-- Search Results Section -->
            <div class="searchContent" id="resultsDisplaySection">
                <h4>Search Results</h4>
                <div id="resultsList" class="card-container"></div>
    
                <!-- Loading Spinner -->
                <div class="spinnerWrapper">
                    <div id="loadingSpinner" class="justify-content-center align-items-center" style="display: none!important;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Pagination Section -->
            <div class="paginationWrapper">
    
                <nav aria-label="Page navigation" id="pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item">
                            <a class="page-link">Previous</a>
                        </li>
                        <li class="page-item"><a class="page-link" href="#">Loading...</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                    <div class="dropdown">
                        <button id="pageSizeButton" class="btn btn-outline-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Size: 10
                        </button>
                        <ul class="dropdown-menu" id="pageSizeDropdown">
                            <li><a class="dropdown-item" href="#" data-pagesize="10">10</a></li>
                            <li><a class="dropdown-item" href="#" data-pagesize="20">20</a></li>
                            <li><a class="dropdown-item" href="#" data-pagesize="50">50</a></li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
    </div>
</div>
<script>
    toggleLoading(true);

    document.addEventListener("DOMContentLoaded", function () {
        // Get the query parameter from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get("q");
        const pageNum = parseInt(urlParams.get("pageNum")) || 1;
        let pageSize = parseInt(urlParams.get("pageSize")) || 10;

        console.log("Query:", query, "PageNum:", pageNum, "PageSize:", pageSize);

        fetchSearchHistory(query);

        if (!query) {
            document.getElementById("resultsList").innerHTML = "<li class='list-group-item'>No query provided. Please try again.</li>";
            return;
        }

        document.getElementById("queryInput").value = query;
            fetchResults(query, pageNum, pageSize).then(() => {
                fetchSearchHistory();
            });

        // Add event listener for page size dropdown
        const pageSizeDropdown = document.getElementById("pageSizeDropdown");
        pageSizeDropdown.addEventListener("click", function (event) {
            const selectedPageSize = event.target.getAttribute("data-pagesize");
            if (selectedPageSize) {
                pageSize = parseInt(selectedPageSize);
                // Update the button text with the selected size
                pageSizeButton.textContent = `Size: ${pageSize}`;
                // Reload the results with the updated page size
                fetchResults(query, 1, pageSize); // Reset to page 1
            }
        });
    });

    function fetchSearchHistory(query) {
        fetch(`/history?q=${encodeURIComponent(query)}`)
            .then(response => response.text())
            .then(data => {
                const historyContainer = document.getElementById("searchHistoryList");
                historyContainer.innerHTML = data;
            })
            .catch(error => console.error("Error fetching search history:", error));
    }

    function fetchResults(query, pageNum, pageSize) {
        toggleLoading(true);

        fetch(`/search?q=${encodeURIComponent(query)}&pageNum=${pageNum}&pageSize=${pageSize}`)
            .then(response => response.text())
            .then(data => {
                document.getElementById("resultsList").innerHTML = data;

                if (data.includes("No results found")) {
                    document.getElementById("pagination").style.display = "none";
                } else {
                    document.getElementById("pagination").style.display = "block";
                }

                const scriptBlock = document.querySelector("#resultsList script");
                if (scriptBlock) {
                    eval(scriptBlock.textContent); // Dynamically parse metadata
                    setupPagination(window.paginationData.currentPage, window.paginationData.totalPages, query, pageSize);
                }
            })
            .catch(error => {
                console.error("Error fetching search results:", error);
                document.getElementById("resultsList").innerHTML = "<li class='list-group-item text-danger'>An error occurred. Please try again.</li>";
            })
            .finally(() => toggleLoading(false));
    }

    function setupPagination(currentPage, totalPages, query, pageSize) {
        const pagination = document.querySelector(".pagination");
        pagination.innerHTML = "";

        // Previous Button
        if (currentPage > 1) {
            pagination.innerHTML += `<li class="page-item">
            <a class="page-link" href="?q=${encodeURIComponent(query)}&pageNum=${currentPage - 1}&pageSize=${pageSize}" aria-label="Previous">Previous</a>
        </li>`;
        } else {
            console.log("here, previous button");
            pagination.innerHTML += `<li class="page-item disabled">
            <a class="page-link" aria-label="Previous">Previous</a>
        </li>`;
        }

        // Page Numbers Logic
        let startPage, endPage;
        if (totalPages <= 5) {
            // Less than or equal to 5 total pages, show all pages
            startPage = 1;
            endPage = totalPages;
        } else {
            // More than 5 pages, calculate start and end to show 5 buttons
            const range = 2; // Number of pages before and after current page
            startPage = Math.max(1, currentPage - range);
            endPage = Math.min(totalPages, currentPage + range);

            // Adjust range to always show 5 buttons
            if (endPage - startPage + 1 < 5) {
                if (startPage === 1) {
                    endPage = Math.min(5, totalPages);
                } else if (endPage === totalPages) {
                    startPage = Math.max(1, totalPages - 4);
                }
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const activeClass = i === currentPage ? "active" : "";
            pagination.innerHTML += `<li class="page-item ${activeClass}">
            <a class="page-link" href="?q=${encodeURIComponent(query)}&pageNum=${i}&pageSize=${pageSize}">${i}</a>
        </li>`;
        }

        // Next Button
        if (currentPage < totalPages) {
            pagination.innerHTML += `<li class="page-item">
            <a class="page-link" href="?q=${encodeURIComponent(query)}&pageNum=${currentPage + 1}&pageSize=${pageSize}" aria-label="Next">Next</a>
        </li>`;
        } else {
            pagination.innerHTML += `<li class="page-item disabled">
            <a class="page-link" aria-label="Next">Next</a>
        </li>`;
        }
    }

    function toggleLoading(isLoading) {
        console.log("Toggling loading spinner:", isLoading);
        const spinner = document.getElementById("loadingSpinner");
        const resultsList = document.getElementById("resultsList");
        const resultsDisplaySection = document.getElementById("resultsDisplaySection");
        const pagination = document.getElementById("pagination");
        const paginationButtons = document.querySelectorAll(".pagination .page-item");
        if (isLoading) {
            // Show spinner and hide results
            spinner.style.display = "flex";
            resultsList.style.display = "none";

            // Disable pagination buttons
            paginationButtons.forEach(button => button.classList.add("disabled"));
        } else {
            // Hide spinner and show results
            spinner.style.display = "none";
            resultsList.style.display = "flex";
            resultsDisplaySection.style.height = "auto";
            pagination.style.display = "flex";
        }
    }
</script>
</body>
</html>
